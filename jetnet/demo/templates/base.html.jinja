<html>
    <head>
        <script src="https://cdn.socket.io/4.5.0/socket.io.min.js" integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/konva@8/konva.min.js"></script>
        <script>
            var socket = io(":{{port}}", {path: "/ws/socket.io"});
        </script>
    </head>
    <body>
        <div id="container"/>
        </div>
        <script>

            fetch('/image_shape')
                .then((response) => response.json())
                .then((image_shape) => {
                    //image_shape = image_shape;//JSON.parse(data);
                    console.log(image_shape);
            {% block setup %}{% endblock %}
            
            var width = window.innerWidth;
            var height = window.innerHeight;

            var stage = new Konva.Stage({
                container: 'container',
                width: width,
                height: height,
            });

            var imageLayer = new Konva.Layer();
            stage.add(imageLayer);

            var overlayLayer = new Konva.Layer();
            stage.add(overlayLayer);

            var imageObj = new Image();

            var konvaImage = new Konva.Image({
                x: 0,
                y: 0,
                width: image_shape.width,
                height: image_shape.height,
                image: imageObj
            });

            imageLayer.add(konvaImage);
            
            imageObj.onload = function() {
                konvaImage.getLayer().draw();
            }
            
            function jpegToBase64(buffer){
                var base64 = btoa(new Uint8Array(buffer).reduce(function (data, byte) {
                    return data + String.fromCharCode(byte);
                }, ''));
                return "data:image/jpeg;base64," + base64;
            }
            
            socket.on("image", (data) => {
                imageObj.src = jpegToBase64(data);
            });

            socket.on("output", (data) => {
                {% block output %}{% endblock %}
            });

            });
        </script>
    </body>
</html>